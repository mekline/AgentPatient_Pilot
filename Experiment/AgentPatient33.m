%AgentPatientStimuli.m
% 
% DESCRIPTION
% Subjects view stimuli - either pictures or sentences ? about one shape
% performing an action on another (e.g., 'Melissa Oval is being bounced by
% Kyle Square'). Sometimes the agent is highlighted; other times the
% patient is highlighted.
% 
% Run PsychStartup; in command line, then call the function
% 
% Function call: AgentPatient33(subjID, image_type, order, run)
% 
% RUNTIME: should be 480 sec (8 min, 240 TRs) ##TOUPDATE
%          -runs 10 times faster with subjID 'debug'
%          -actually takes about 1475 sec due to lag
% 
% INPUTS:
%   -subjID: subject ID string
%   -image_type: 'sentences' for sentence stimuli, 'stills' for picture
%   stimuli
%   -order: A, B, C D, or E; determines which preset item ordering to use
%   -(Each participant should get at least XXX runs, each with a different
%   ordering)
% 
% OUTPUT:
%   -.csv file with information on what was presented when to whom for how
%   long (data/AgentPatient33_subjID_image_type_order_data.csv)
% 
% ADJUSTMENTS:
% To change font size, go to Set display options.
% If the aspect ratio is off, change SCREEN_ADJUST in Set experiment
% constants until it looks better.

function AgentPatientStimuli(subjID, image_type, order)



    start_time = GetSecs;
    

    %% Make sure inputs are valid and raise an error otherwise
    %subjID is a string
    assert(ischar(subjID), 'subjID (first argument) must be a string');

    %image_type is 'sentences' or 'stills'
    assert(strcmp(image_type, 'sentences') | strcmp(image_type, 'stills'), sprintf('image_type (second argument) must be ''sentences'' or ''stills''\nExample of correct format: AgentPatientStimuli(''myID'',''sentences'',''A'',1)'));
    
    %order is a letter A-E
    assert(ismember(order, ['A','B','C','D','E']), sprintf('order (third argument) must be a letter A-E enclosed in quotes\nExample of correct format: AgentPatientStimuli(''myID'',''sentences'',''A'',1)'));
 
    %% Make sure we don't accidentally overwrite a data file
    %This is where the data file will go
    DATA_DIR = fullfile(pwd, 'data');
    %This is what we'll call the data file we're making
    fileToSave = ['AgentPatient33_' subjID '_' image_type '_' order '_data.csv'];
    %The file should be in the DATA_DIR folder
    fileToSave = fullfile(DATA_DIR, fileToSave);
    
    % Error message if data file already exists.
    if exist(fileToSave,'file') && ~strcmpi(subjID, 'debug')
        str = input('The data file already exists for this subject! Overwrite? (y/n)','s');
        if ~isequal(str,'y')
            error('The data file already exists for this subject!');
        end
	end
    
        
    %% Set experiment constants

    %Timing (in seconds)              
    FIX_DUR     = 0.0; %Length of trial-initial fixation
    ITI         = 0.0; %Inter-trial interval
    BLINK_DUR   = 0.2; %Length of one blink on or off
    SCREEN_ADJUST = 1.2; %factor to adjust aspect ratio by
    
    %Based on image type (sentences or stills), decide what Flip means
    switch image_type
        case 'sentences'
            %all_materials.Flip is just 0 or 1; this is what it means in each case
            flip_word_0 = 'active';
            flip_word_1 = 'passive';
        case 'stills'
            flip_word_0 = 'orig';
            flip_word_1 = 'flipped';
    end

    %% Set up orders
    
    %Each csv in ORDER_DIR was generated by optseq2 using these arguments
    %./optseq2 (calls program)
    %--ntp 180  (number of time points - a time point is one time rate long)
    %--tr 2 (time rate - smallest time unit)
    %--tprescan 0 (no idea)
    %--psdwin 0 12 (this is a response thing, don't think we need it)
    %--ev Active 2 60 (event condition, max time (multiple of tr) we can
    %show it for, number of times it should come up)
    %--ev Passive 2 60 (see above)
    %--nkeep 10 (how many orderings to keep)
    %--o ORDER (what to name output files; doesn't matter because we
    %renamed them anyway)
    %--nsearch 10000 (how many orderings to try)
    
    %This has all the info
    ORDER_DIR = fullfile(pwd, 'orders'); %folder containing all orders
    
    order_filename = ['AgentPatient33_Order' order num2str(run) '_vers2.csv']; %order for this run
    order_filename = fullfile(ORDER_DIR, order_filename); %full path for that order
    all_materials = readtable(order_filename); %order stored as a table
    
    numEvents = height(all_materials); %the total number of trials and fixations
    
    %% Make the experiment run faster if subjID is 'debug'
    if strcmpi(subjID, 'debug')
        scale = 0.02;
        FIX_DUR = FIX_DUR * scale;
        BLINK_DUR = BLINK_DUR * scale;
        ITI = ITI * scale;
        
        all_materials.IntendedOnset = all_materials.IntendedOnset * scale;
        all_materials.IntendedDuration = all_materials.IntendedDuration * scale;
    end
    
    %% Read in the stimuli materials
    %Info on order_filename:
    %This is a .csv file, specific to the order and run, with all the info
    %we need for each run. There exist XXX files total, one for each order
    
    %Below are descriptions of the important variables in the file:
    
    %IntendedOnset: onset time scheduled by Optseq (different from actual onset
    %stored in results data file)
    
    %Duration: how long to show the item
    
    %Condition: agent highlighted, patient highlighted, or NULL (fixation
    %cross).
    
    %Flip: for linguistic stimuli, Flip determines whether the active or
    %passive version of the sentence is presented. 0 means active, while 1
    %indicates passive.
    
    %Order_agent: index at which the agent-highlight version of the
    %sentence is presented, relative to all the agent-highlight versions.
    %For instance, if Order_agent for an item is 42, it will
    %be the 42nd agent-highlight item presented, although it won't be the
    %42nd item presented overall because there will be patient-highlight
    %items interspersed with the agent-highlight items.
    
    %Order_patient: like Order_agent, but for patients.
    
    %Condition, Flip, Order_agent, and Order_patient were all randomly
    %generated in an Excel spreadsheet and are random with respect to each
    %other as well as with respect to the sentence items.
    
    
    %Save all_materials to a matfile
    MATERIALS_DIR = fullfile(pwd, 'materials'); %where to put the saved materials
    mat_filename = ['AgentPatient33_' subjID '_' order '_materials.mat']; %materials to save
    mat_filename = fullfile(MATERIALS_DIR, mat_filename);
    save(mat_filename, 'all_materials'); %save all_materials as mat_filename
    
    %Load the all_materials table from the mat file
    %If the mat file doesn't exist, make sure the user entered the correct
    %inputs
    try
         load(mat_filename);
         
    catch errorInfo
         fprintf('%s%s\n\n', 'error message: ', errorInfo.message)
         
         error('\n%s\n\t%s\n\t%s\n', ...
               'Please make sure the following conditions are met:', ...
               '1) subjID is the same for run 1 and run 2', ...
               '2) run is 1 for the first run and 2 for the second');
    end
     
     %Set up the data that we want to save
     resultsHdr = {'Trial', 'SubjID',        'Run',       'Order',   'ItemNumber'   'IntendedOnset', ...
                   'ActualOnset', 'IntendedDuration', 'ActualDuration',      'Condition', 'Flip', 'FlipMeaning',  'Sentence', ...
                   'AgentName',     'AgentShape',          'PatientName'...
                   'PatientShape', 'BaseFilename', 'BlinkFilename'};
 	
     %Set up results, the table that will hold this data
     results = cell(numEvents, length(resultsHdr));
     results = cell2table(results, 'VariableNames', resultsHdr);
    
    %Fill in the user input information
    results.SubjID(:) = {subjID};
	results.Run   = ones(numEvents,1)*run;
    results.Order(:) = {order};
    %eventually change these to just 1 entry
    
    %Fill in Condition anxd Flip in the results file, one by one
    for eventNum=1:numEvents
        results.Condition{eventNum} = char(all_materials.Condition(eventNum));
        results.Flip{eventNum} = char(all_materials.Flip(eventNum));
        results.ItemNumber{eventNum} = char(all_materials.ItemNumber(eventNum));
        results.IntendedOnset{eventNum} = all_materials.IntendedOnset(eventNum);
        results.IntendedDuration{eventNum} = all_materials.IntendedDuration(eventNum);
    end

	%% Set up screen and keyboard for Psychtoolbox
    %Screen
    screenNum = max(Screen('Screens'));  %Highest screen number is most likely correct display
    windowInfo = PTBhelper('initialize',screenNum);
	wPtr = windowInfo{1}; %pointer to window on screen that's being referenced
    rect = windowInfo{2}; %dimensions of the window
        winWidth = rect(3);
        winHeight = rect(4)*SCREEN_ADJUST;
    oldEnableFlag = windowInfo{4};
    HideCursor;
    PTBhelper('stimImage',wPtr,'WHITE');
    PTBhelper('stimText',wPtr,'Loading images\n\n(Don''t start yet!)',30);
    
    
    %Keyboard
    keyboardInfo = [];
    keyboardInfo = PTBhelper('getKeyboardIndex');
    kbIdx = [keyboardInfo{1}]
    escapeKey = keyboardInfo{2};
    
    %% Set up cells containing image file data
    %Initialize the cells and IMAGE_DIR
    
    %images with highlight
    img_files = cell(1,120);
    img_stims = cell(1,120);
    
    %images with no highlight
    base_files = cell(1,120);
    base_stims = cell(1,120);
    
    IMAGE_DIR = fullfile(pwd, 'images', image_type); %the folder we're taking images from

    index = 1; %counter
    load_start_time = GetSecs;
    for eventNum=1:numEvents
        condition = all_materials.Condition(eventNum);
        intendedDuration = all_materials.IntendedDuration(eventNum);
        flip = all_materials.Flip{eventNum};
   
        if ~strcmp(char(condition), '0') %if this trial isn't a fixation
            %Determine flip
            switch flip
                case '0'
                    flip_word = flip_word_0;
                case '1'
                    flip_word = flip_word_1;
            end

            %what is the name of the image we want
            img_name = [char(condition) '_' flip_word '_' char(all_materials.ItemNumber{eventNum}) '.jpg'];
            base_name = ['Base_' flip_word '_' char(all_materials.ItemNumber{eventNum}) '.jpg'];
            
            %put it into a cell with the other image files
            img_files{1,index} = fullfile(IMAGE_DIR, img_name);
            base_files{1,index} = fullfile(IMAGE_DIR, base_name);
            
            %read in the image file we want
            %image = img_files{index};
            %image = imread(image);
            
            %read in the base file we want
            base = base_files{index};
            base = imread(base,'jpg');
            image = img_files{index};
            image = imread(image,'jpg');
            fclose('all');
 
            
            %read in the base file we want
            %base = base_files{index};
            %base = imread(base,'jpg'); %Taking a long time
            fclose('all');
            %base = imresize(base, [winHeight, NaN]); %Taking a long time
            
            %make it a texture so PTBHelper will like it
            img_stims{index} = Screen('MakeTexture', wPtr, double(image));
            base_stims{index} = Screen('MakeTexture', wPtr, double(base));

        
        results.BlinkFilename{eventNum} = char(img_name);
        results.BaseFilename{eventNum} = char(base_name);
        results.FlipMeaning{eventNum} = char(flip_word);
        results.Trial{eventNum} = index;
        index = index+1; %increment counter
        
        PTBhelper('stimText',wPtr,['Loading images\n\n(Don''t start yet!)\n' num2str(index) '/120'],30);
 
        end
    end 
    load_end_time = GetSecs;
    load_time = load_end_time - load_start_time
  
    %% Set display options
    %Font sizes
    sentFontSize = 40;      %stimuli sentences
    fixFontSize = 40;       %fixation cross
    
    %% Present the experiment
	% Wait indefinitely until trigger
    PTBhelper('stimText',wPtr,'Waiting for trigger...',sentFontSize);
    PTBhelper('waitFor','TRIGGER',kbIdx,escapeKey);
    
    runOnset = GetSecs; %remains the same
    %%MK actualOnset = runOnset;   %updates for each trial
    item_index = 1;
    
    %Present each block
    try
        for eventNum = 1:numEvents
            
            condition = all_materials.Condition(eventNum);
            intendedOnset = all_materials.IntendedOnset(eventNum);
            intendedDuration = all_materials.IntendedDuration(eventNum);
            intendedOffset = intendedOnset + intendedDuration;
            flip = all_materials.Flip{eventNum};
            
            actualOnset = GetSecs-runOnset; %What time is it right now?
   
            %If it's fixation
            if strcmp(condition, '0')

                %Show fixation cross
                PTBhelper('stimText', wPtr, '+', fixFontSize);
                fixEndTime = runOnset + intendedOffset;
                PTBhelper('waitFor',fixEndTime,kbIdx,escapeKey);
                
                %Save data
                
                results.Sentence{eventNum} = 'NA';
                results.AgentName{eventNum} = 'NA';
                results.AgentShape{eventNum} = 'NA';
                results.PatientName{eventNum} = 'NA';
                results.PatientShape{eventNum} = 'NA';
                
                %Update loop variables
                %%MKactualOnset = fixEndTime;
               
            else %If there's a sentence to be presented (i.e., not NULL)
                if char(all_materials.Flip(eventNum)) == '0'
                    sentence = char(all_materials.ProgressiveActive(eventNum));
                elseif char(all_materials.Flip(eventNum)) == '1'
                    sentence = char(all_materials.ProgressivePassive(eventNum));
                end
                
                %Show sentence trial
                %Trial-initial fixation
                %PTBhelper('stimText', wPtr, '+', fixFontSize);
                %fixEndTime = actualOnset + FIX_DUR;
                %PTBhelper('waitFor',fixEndTime,kbIdx,escapeKey);

                %Blink sentence until !!ALMOST!! sentEndTime
                sentEndTime = runOnset + intendedOffset;
                while GetSecs < (sentEndTime-3*BLINK_DUR) %Any fewer than this tends to lead to long bleedovers that have to be corrected/uneven trial lengths
                    PTBhelper('stimImage', wPtr, item_index, img_stims);
                    WaitSecs(BLINK_DUR);
                    PTBhelper('stimImage', wPtr, item_index, base_stims);
                    WaitSecs(BLINK_DUR);
                end
                
                %Catch up to the end of the trial.
                PTBhelper('waitFor',sentEndTime,kbIdx,escapeKey);
                

                %Blank ITI
                %PTBhelper('stimText', wPtr, ' ', sentFontSize);
                %blankEndTime = sentEndTime + ITI;
                %PTBhelper('waitFor',blankEndTime,kbIdx,escapeKey);
                %store ActualDuration
                %%MKresults.ActualDuration{eventNum} = GetSecs - actualOnset;
                %update actualOnset
                %%MKactualOnset = sentEndTime;
                
                %Save Sentence, agent info to results
                results.Sentence{eventNum} = sentence;
                results.AgentName{eventNum} = char(all_materials.AgentName(eventNum));
                results.AgentShape{eventNum} = char(all_materials.AgentShape(eventNum));
                results.PatientName{eventNum} = char(all_materials.PatientName(eventNum));
                results.PatientShape{eventNum} = char(all_materials.PatientShape(eventNum));
                %%MKresults.ActualOnset{eventNum} = actualOnset;
                
            %Update loop variables
            item_index = item_index + 1;
                
            end
            
            %%MK Save actual onset and duration back to the results file!
            results.ActualOnset{eventNum} = actualOnset;
            actualDuration = GetSecs - (actualOnset + runOnset);
            results.ActualDuration{eventNum} = actualDuration;
            
        end

        ran_completely = true;
        
    catch errorInfo
        ran_completely = false;
        
        fprintf('%s%s\n\n', 'error message: ', errorInfo.message)
        for k=1:length(errorInfo.stack)
            disp(errorInfo.stack(k))
        end
    end
    
    %Save all data
	writetable(results, fileToSave);
    
     %Close the PTB screen
	Screen('CloseAll');
	ShowCursor;
    
    %Restore the old level.
    Screen('Preference','SuppressAllWarnings',oldEnableFlag);
    other_run = 3 - run;
    disp(['Run ' order num2str(run) ' finished; data for this run saved to ' fileToSave])
    other_run_data = ['AgentPatientStimuli_' subjID '_' image_type '_' order num2str(other_run) '_data.csv'];
    other_run_data = fullfile(pwd, 'data', other_run_data);
    if exist(other_run_data,'file') == 0
        disp(['Make sure to run ' order num2str(other_run) ' during this scanning session as well.'])
    end
end

%% %% Debugging functions
function [wPtr, rect] = openDebugWindow(screenNum, rect)
    Screen('CloseAll');
    ShowCursor;
    clear Screen
    
    rect = rect / 2;
    rect(1) = 5;
    rect(2) = 5;

    java; %clear java cache
    KbName('UnifyKeyNames');
    warning('off','MATLAB:dispatcher:InexactMatch');
    AssertOpenGL;
    suppress_warnings = 1;
    Screen('Preference', 'SuppressAllWarnings', suppress_warnings);
    Screen('Preference', 'TextRenderer', 0);
    Screen('Preference', 'SkipSyncTests', 1);
    [wPtr,rect] = Screen('OpenWindow',screenNum,1,rect,[],[],[],[],[],kPsychGUIWindow,[]);
end

        


